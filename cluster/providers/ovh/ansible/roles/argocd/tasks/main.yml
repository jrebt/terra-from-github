---
- name: Create ArgoCD namespace
  command: kubectl create namespace {{ argocd_namespace }}
  failed_when: false
  changed_when: false

- name: Install ArgoCD
  command: kubectl apply -n {{ argocd_namespace }} -f {{ argocd_install_manifest }}
  register: argocd_install
  changed_when: "'created' in argocd_install.stdout or 'configured' in argocd_install.stdout"

- name: Wait for ArgoCD to be ready
  command: kubectl wait --for=condition=available --timeout=300s deployment/argocd-server -n {{ argocd_namespace }}

- name: Patch ArgoCD server service to LoadBalancer
  command: |
    kubectl patch svc argocd-server -n {{ argocd_namespace }} -p '{"spec": {"type": "LoadBalancer"}}'

- name: Set ArgoCD server to insecure mode (for Traefik ingress)
  command: |
    kubectl patch configmap argocd-cmd-params-cm -n {{ argocd_namespace }} --type merge -p '{"data": {"server.insecure": "true"}}'

- name: Restart ArgoCD server to apply insecure mode
  command: kubectl rollout restart deployment/argocd-server -n {{ argocd_namespace }}

- name: Wait for ArgoCD server restart
  command: kubectl wait --for=condition=available --timeout=120s deployment/argocd-server -n {{ argocd_namespace }}

- name: Get ArgoCD admin password
  shell: kubectl -n {{ argocd_namespace }} get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
  register: argocd_password
  changed_when: false

- name: Display ArgoCD access information
  debug:
    msg:
      - "ArgoCD is installed!"
      - "Username: admin"
      - "Password: {{ argocd_password.stdout }}"
